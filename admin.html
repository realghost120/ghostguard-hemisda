<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<title>GhostGuard Admin</title>

<style>
:root{
  --bg-dark: #060c18;
  --bg-card: #101a2e;
  --bg-light: #0a1222;
  --card-dark: #101a2e;
  --card-light: #0d1628;
  --blue: #3b82f6;
  --blue-glow: rgba(59,130,246,.4);
  --blue-hover: rgba(59,130,246,.15);
  --blue-active: rgba(59,130,246,.25);
  --red: #ef4444;
  --yellow: #f59e0b;
  --green: #22c55e;
  --border: rgba(255,255,255,.06);
  --text: #e6f0ff;
  --text-muted: rgba(230,240,255,.6);
}
*{box-sizing:border-box}
body{
 margin:0;
 font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
 color:var(--text);
 background:radial-gradient(900px 500px at 50% 0%,rgba(59,130,246,.20),transparent 60%),
            linear-gradient(180deg,var(--bg-dark),var(--bg-light));
 min-height:100vh;
 animation:fadeIn .35s ease;
}
@keyframes fadeIn {
 from { opacity: 0; transform: translateY(10px); }
 to { opacity: 1; transform: translateY(0); }
}
@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}
@keyframes loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
header{
 display:flex;justify-content:space-between;align-items:center;
 padding:18px 28px;
 border-bottom:1px solid rgba(255,255,255,.06);
 background:rgba(5,7,13,.55);
 backdrop-filter:blur(10px);
}
.brand{font-weight:900;font-size:18px}
.wrap{max-width:1100px;margin:0 auto;padding:26px 18px 60px}
.card{
 background:linear-gradient(180deg,var(--card-dark),var(--card-light));
 border:1px solid var(--border);
 border-radius:16px;
 padding:16px;
 box-shadow:0 22px 70px rgba(0,0,0,.35);
 margin-bottom:14px;
 transition:.2s;
}
.card:hover{transform:translateY(-2px);border-color:var(--blue-glow)}
.title{font-weight:900;font-size:18px;margin-bottom:10px}
label{display:block;margin-top:10px;font-size:12px;color:var(--text-muted);font-weight:800}
input{
 width:100%;
 margin-top:6px;
 padding:11px 12px;
 border-radius:10px;
 background:rgba(0,0,0,.25);
 color:var(--text);
 border:1px solid var(--border);
 outline:none;
}
input:focus{border-color:var(--blue-glow);box-shadow:0 0 0 3px rgba(59,130,246,.2)}
.row{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
.btn{
 border:none;cursor:pointer;font-weight:900;
 padding:10px 14px;border-radius:10px;
 color:var(--text);
 background:rgba(255,255,255,.05);
 border:1px solid var(--border);
 transition:.18s;
}
.btn:hover{transform:translateY(-1px);border-color:var(--blue-glow)}
.btn-primary,.btn-blue{background:var(--blue);border-color:transparent;color:#fff}
.btn-success,.btn-green{background:rgba(34,197,94,.2);border-color:rgba(34,197,94,.45);color:#b8f3cc}
.btn-danger,.btn-red{background:rgba(239,68,68,.2);border-color:rgba(239,68,68,.45);color:#ffc1c1}
table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:13px}
th{color:rgba(232,240,255,.8);font-size:12px;background:rgba(59,130,246,.08)}
tbody tr:hover td{background:rgba(59,130,246,.08)}
.pill{display:inline-flex;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);
 background:rgba(0,0,0,.22);font-weight:900;font-size:12px}
.good{color:var(--green)}
.bad{color:var(--red)}
.mono{font-family:monospace}
.msg{margin-top:10px;color:var(--text-muted);min-height:18px;white-space:pre-wrap}
.small{font-size:12px;color:var(--text-muted)}
.skeleton {
  background: linear-gradient(90deg, var(--bg-card) 25%, var(--bg-dark) 50%, var(--bg-card) 75%);
  background-size: 200% 100%;
  animation: loading 1.5s infinite;
}
</style>
</head>
<body>

<header>
  <div class="brand"><i class="fas fa-ghost"></i> GhostGuard • Admin Panel</div>
  <button class="btn" id="refresh"><i class="fas fa-sync-alt"></i> Refresh</button>
</header>

<div class="wrap">

  <div class="card">
    <div class="title"><i class="fas fa-lock"></i> Admin Secret</div>
    <input id="secret" type="password" placeholder="ADMIN_SECRET"/>
    <button class="btn btn-blue" id="saveSecret"><i class="fas fa-save"></i> Spara</button>
    <div class="small">Skickas som: <span class="mono">Authorization: Bearer &lt;secret&gt;</span></div>
    <div class="msg" id="secretMsg"></div>
  </div>

  <div class="card">
    <div class="title"><i class="fas fa-plus-circle"></i> Skapa ny licens</div>
    <div class="row">
      <div>
        <label>Dagar giltig</label>
        <input id="days" type="number" value="30"/>
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn btn-green" id="createLicense"><i class="fas fa-key"></i> Skapa</button>
      </div>
      <div>
        <label>Resultat</label>
        <input id="newLicense" readonly/>
      </div>
    </div>
    <div class="msg" id="licMsg"></div>
  </div>

  <div class="card">
    <div class="title"><i class="fas fa-user"></i> Skapa kund</div>

    <div class="row">
      <div>
        <label>Username</label>
        <input id="cu" placeholder="kund1"/>
      </div>

      <div>
        <label>Password</label>
        <input id="cp" type="password" placeholder="lösenord"/>
      </div>

      <div>
        <label>License Key</label>
        <input id="ck" placeholder="GG-XXXX-XXXX"/>
      </div>
    </div>

    <div style="margin-top:10px;">
      <button class="btn btn-blue" id="createCustomer"><i class="fas fa-user-plus"></i> Skapa kund</button>
    </div>

    <div class="msg" id="custMsg"></div>
  </div>

  <div class="card">
    <div class="title"><i class="fas fa-clipboard-list"></i> Alla licenser</div>
    <table>
      <thead>
        <tr>
          <th>Key</th>
          <th>Status</th>
          <th>Expires</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <div class="msg" id="listMsg"></div>
  </div>

</div>

<script>
/** ========= CONFIG ========= */
const API_BASE = "https://ghostgaurd-becakd.onrender.com";

/** ========= STORAGE ========= */
function getSecret(){ return localStorage.getItem("gg_admin_secret") || ""; }
function setSecret(v){ localStorage.setItem("gg_admin_secret", v); }

document.getElementById("secret").value = getSecret();

document.getElementById("saveSecret").onclick = () => {
  setSecret(document.getElementById("secret").value.trim());
  document.getElementById("secretMsg").innerText = "Secret sparat";
};

/** ========= HELPERS ========= */
function authHeaders(){
  return {
    "Content-Type": "application/json",
    "Authorization": "Bearer " + getSecret()
  };
}

function statusPill(s){
  const ok = (s === "ACTIVE");
  return `<span class="pill ${ok ? "good" : "bad"}">${s || "-"}</span>`;
}

async function safeJson(res){
  const text = await res.text();
  try { return { json: JSON.parse(text), raw: text }; }
  catch { return { json: null, raw: text }; }
}

function showMsg(id, msg){ document.getElementById(id).innerText = msg || ""; }

/** ========= API CALLS ========= */
async function loadLicenses(){
  showMsg("listMsg", "");

  const res = await fetch(API_BASE + "/admin/licenses", { headers: authHeaders() });
  const { json, raw } = await safeJson(res);

  if (!res.ok){
    showMsg("listMsg", `Fel (${res.status}): ${json?.error || raw || "okänt"}`);
    return;
  }

  if (!json || json.success !== true){
    showMsg("listMsg", "Fel: kunde inte läsa licenser.");
    return;
  }

  const rows = (json.data || []).map(l => {
    const key = l.license_key || "-";
    const status = l.status || "-";
    const expires = l.expires_at || "-";
    const nextStatus = (status === "ACTIVE") ? "DISABLED" : "ACTIVE";
    const btnClass = (status === "ACTIVE") ? "btn-red" : "btn-green";
    const btnText = (status === "ACTIVE") ? "Stäng av" : "Aktivera";

    return `
      <tr>
        <td class="mono">${key}</td>
        <td>${statusPill(status)}</td>
        <td class="mono">${expires}</td>
        <td>
          <button class="btn ${btnClass}" onclick="toggleLicense('${key}','${nextStatus}')">${btnText}</button>
        </td>
      </tr>
    `;
  }).join("");

  document.getElementById("tbody").innerHTML = rows || `
    <tr><td colspan="4" class="small">Inga licenser hittades.</td></tr>
  `;
}

async function toggleLicense(license_key, status){
  showMsg("listMsg", "");

  const res = await fetch(API_BASE + "/admin/toggle-license", {
    method: "POST",
    headers: authHeaders(),
    body: JSON.stringify({ license_key, status })
  });

  const { json, raw } = await safeJson(res);

  if (!res.ok){
    showMsg("listMsg", `Toggle fel (${res.status}): ${json?.error || raw || "okänt"}`);
    return;
  }

  await loadLicenses();
}

document.getElementById("createLicense").onclick = async () => {
  showMsg("licMsg", "");
  const days = Number(document.getElementById("days").value);

  const res = await fetch(API_BASE + "/admin/create-license", {
    method: "POST",
    headers: authHeaders(),
    body: JSON.stringify({ days_valid: days })
  });

  const { json, raw } = await safeJson(res);

  if (!res.ok){
    showMsg("licMsg", `Fel (${res.status}): ${json?.error || raw || "okänt"}`);
    return;
  }

  if (json?.success){
    document.getElementById("newLicense").value = json.license_key || "";
    showMsg("licMsg", "Licens skapad");
    await loadLicenses();
  } else {
    showMsg("licMsg", "Fel: " + (json?.error || raw || "okänt"));
  }
};

document.getElementById("createCustomer").onclick = async () => {
  showMsg("custMsg", "");

  const username = document.getElementById("cu").value.trim();
  const password = document.getElementById("cp").value.trim();
  const license_key = document.getElementById("ck").value.trim();

  if (!username || !password || !license_key){
    showMsg("custMsg", "Fyll i alla fält.");
    return;
  }

  const res = await fetch(API_BASE + "/admin/create-customer", {
    method: "POST",
    headers: authHeaders(),
    body: JSON.stringify({ username, password, license_key })
  });

  const { json, raw } = await safeJson(res);

  if (!res.ok){
    showMsg("custMsg", `Fel (${res.status}): ${json?.error || raw || "okänt"}`);
    return;
  }

  if (json?.success){
    showMsg("custMsg", "Kund skapad");
    document.getElementById("cu").value = "";
    document.getElementById("cp").value = "";
    document.getElementById("ck").value = "";
  } else {
    showMsg("custMsg", "Fel: " + (json?.error || raw || "okänt"));
  }
};

document.getElementById("refresh").onclick = loadLicenses;
loadLicenses();
</script>
>

</body>
</html>

