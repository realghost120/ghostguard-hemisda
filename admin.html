<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>GhostGuard Admin</title>

<style>
:root{
 --bg1:#070b14; --bg2:#05070d;
 --text:#e8f0ff; --muted:rgba(232,240,255,.65);
 --blue:#3b82f6; --green:#22c55e; --red:#ef4444;
 --shadow:0 18px 70px rgba(0,0,0,.55);
 --radius:18px;
}
*{box-sizing:border-box}
body{
 margin:0;
 font-family:Arial,sans-serif;
 color:var(--text);
 background:radial-gradient(900px 500px at 50% 0%,rgba(59,130,246,.20),transparent 60%),
            linear-gradient(180deg,var(--bg1),var(--bg2));
 min-height:100vh;
}
header{
 display:flex;justify-content:space-between;align-items:center;
 padding:18px 28px;
 border-bottom:1px solid rgba(255,255,255,.06);
 background:rgba(5,7,13,.55);
 backdrop-filter:blur(10px);
}
.brand{font-weight:900;font-size:18px}
.wrap{max-width:1100px;margin:0 auto;padding:26px 18px 60px}
.card{
 background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
 border:1px solid rgba(255,255,255,.08);
 border-radius:var(--radius);
 padding:16px;
 box-shadow:var(--shadow);
 margin-bottom:14px;
}
.title{font-weight:900;font-size:18px;margin-bottom:10px}
label{display:block;margin-top:10px;font-size:12px;color:var(--muted);font-weight:800}
input{
 width:100%;
 margin-top:6px;
 padding:11px 12px;
 border-radius:12px;
 background:rgba(0,0,0,.25);
 color:var(--text);
 border:1px solid rgba(255,255,255,.10);
 outline:none;
}
input:focus{border-color:rgba(59,130,246,.55)}
.row{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
.btn{
 border:none;cursor:pointer;font-weight:900;
 padding:10px 14px;border-radius:12px;
 color:var(--text);
 background:rgba(255,255,255,.06);
 border:1px solid rgba(255,255,255,.08);
 transition:.18s;
}
.btn:hover{transform:translateY(-1px);border-color:rgba(96,165,250,.35)}
.btn-blue{background:rgba(59,130,246,.18);border-color:rgba(59,130,246,.35)}
.btn-green{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.35)}
.btn-red{background:rgba(239,68,68,.18);border-color:rgba(239,68,68,.35)}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;font-size:13px}
th{color:rgba(232,240,255,.8);font-size:12px}
.pill{display:inline-flex;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);
 background:rgba(0,0,0,.22);font-weight:900;font-size:12px}
.good{color:var(--green)}
.bad{color:var(--red)}
.mono{font-family:monospace}
.msg{margin-top:10px;color:var(--muted);min-height:18px;white-space:pre-wrap}
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>

<header>
  <div class="brand">GhostGuard ‚Ä¢ Admin Panel</div>
  <button class="btn" id="refresh">Refresh</button>
</header>

<div class="wrap">

  <div class="card">
    <div class="title">üîê Admin Secret</div>
    <input id="secret" type="password" placeholder="ADMIN_SECRET"/>
    <button class="btn btn-blue" id="saveSecret">Spara</button>
    <div class="small">Skickas som: <span class="mono">Authorization: Bearer &lt;secret&gt;</span></div>
    <div class="msg" id="secretMsg"></div>
  </div>

  <div class="card">
    <div class="title">‚ûï Skapa ny licens</div>
    <div class="row">
      <div>
        <label>Dagar giltig</label>
        <input id="days" type="number" value="30"/>
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn btn-green" id="createLicense">Skapa</button>
      </div>
      <div>
        <label>Resultat</label>
        <input id="newLicense" readonly/>
      </div>
    </div>
    <div class="msg" id="licMsg"></div>
  </div>

  <div class="card">
    <div class="title">üë§ Skapa kund</div>

    <div class="row">
      <div>
        <label>Username</label>
        <input id="cu" placeholder="kund1"/>
      </div>

      <div>
        <label>Password</label>
        <input id="cp" type="password" placeholder="l√∂senord"/>
      </div>

      <div>
        <label>License Key</label>
        <input id="ck" placeholder="GG-XXXX-XXXX"/>
      </div>
    </div>

    <div style="margin-top:10px;">
      <button class="btn btn-blue" id="createCustomer">Skapa kund</button>
    </div>

    <div class="msg" id="custMsg"></div>
  </div>

  <div class="card">
    <div class="title">üìã Alla licenser</div>
    <table>
      <thead>
        <tr>
          <th>Key</th>
          <th>Status</th>
          <th>Expires</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <div class="msg" id="listMsg"></div>
  </div>

</div>

<script>
/** ========= CONFIG =========
 * Byt bara API_BASE till din Render URL.
 * OBS: du stavade "gaurd" i Render, s√• vi anv√§nder exakt den.
 */
const API_BASE = "https://ghostgaurd-becakd.onrender.com";

/** ========= STORAGE ========= */
function getSecret(){ return localStorage.getItem("gg_admin_secret") || ""; }
function setSecret(v){ localStorage.setItem("gg_admin_secret", v); }

document.getElementById("secret").value = getSecret();

document.getElementById("saveSecret").onclick = () => {
  setSecret(document.getElementById("secret").value.trim());
  document.getElementById("secretMsg").innerText = "Secret sparat ‚úÖ";
};

/** ========= HELPERS ========= */
function authHeaders(){
  return {
    "Content-Type": "application/json",
    "Authorization": "Bearer " + getSecret()
  };
}

function statusPill(s){
  const ok = (s === "ACTIVE");
  return `<span class="pill ${ok ? "good" : "bad"}">${s || "-"}</span>`;
}

async function safeJson(res){
  const text = await res.text();
  try { return { json: JSON.parse(text), raw: text }; }
  catch { return { json: null, raw: text }; }
}

function showMsg(id, msg){ document.getElementById(id).innerText = msg || ""; }

/** ========= API CALLS ========= */
async function loadLicenses(){
  showMsg("listMsg", "");
  const res = await fetch(API_BASE + "/admin/licenses", { headers: authHeaders() });
  const { json, raw } = await safeJson(res);

  if (!res.ok){
    showMsg("listMsg", `Fel (${res.status}): ${json?.error || raw || "ok√§nt"}`);
    return;
  }

  if (!json || json.success !== true){
    showMsg("listMsg", "Fel: kunde inte l√§sa licenser.");
    return;
  }

  const rows = (json.data || []).map(l => {
    const key = l.license_key || "-";
    const status = l.status || "-";
    const expires = l.expires_at || "-";
    const nextStatus = (status === "ACTIVE") ? "DISABLED" : "ACTIVE";
    const btnClass = (status === "ACTIVE") ? "btn-red" : "btn-green";
    const btnText = (status === "ACTIVE") ? "St√§ng av" : "Aktivera";

    return `
      <tr>
        <td class="mono">${key}</td>
        <td>${statusPill(status)}</td>
        <td class="mono">${expires}</td>
        <td>
          <button class="btn ${btnClass}" onclick="toggleLicense('${key}','${nextStatus}')">${btnText}</button>
        </td>
      </tr>
    `;
  }).join("");

  document.getElementById("tbody").innerHTML = rows || `
    <tr><td colspan="4" class="small">Inga licenser hittades.</td></tr>
  `;
}

async function toggleLicense(license_key, status){
  showMsg("listMsg", "");
  const res = await fetch(API_BASE + "/admin/toggle-license", {
    method: "POST",
    headers: authHeaders(),
    body: JSON.stringify({ license_key, status })
  });

  const { json, raw } = await safeJson(res);
  if (!res.ok){
    showMsg("listMsg", `Toggle fel (${res.status}): ${json?.error || raw || "ok√§nt"}`);
    return;
  }
  await loadLicenses();
}

document.getElementById("createLicense").onclick = async () => {
  showMsg("licMsg", "");
  const days = Number(document.getElementById("days").value);

  const res = await fetch(API_BASE + "/admin/create-license", {
    method: "POST",
    headers: authHeaders(),
    body: JSON.stringify({ days_valid: days })
  });

  const { json, raw } = await safeJson(res);

  if (!res.ok){
    showMsg("licMsg", `Fel (${res.status}): ${json?.error || raw || "ok√§nt"}`);
    return;
  }

  if (json?.success){
    document.getElementById("newLicense").value = json.license_key || "";
    showMsg("licMsg", "Licens skapad ‚úÖ");
    await loadLicenses();
  } else {
    showMsg("licMsg", "Fel: " + (json?.error || raw || "ok√§nt"));
  }
};

document.getElementById("createCustomer").onclick = async () => {
  showMsg("custMsg", "");

  const username = document.getElementById("cu").value.trim();
  const password = document.getElementById("cp").value.trim();
  const license_key = document.getElementById("ck").value.trim();

  if (!username || !password || !license_key){
    showMsg("custMsg", "Fyll i alla f√§lt.");
    return;
  }

  const res = await fetch(API_BASE + "/admin/create-customer", {
    method: "POST",
    headers: authHeaders(),
    body: JSON.stringify({ username, password, license_key })
  });

  const { json, raw } = await safeJson(res);

  if (!res.ok){
    showMsg("custMsg", `Fel (${res.status}): ${json?.error || raw || "ok√§nt"}`);
    return;
  }

  if (json?.success){
    showMsg("custMsg", "Kund skapad ‚úÖ");
    document.getElementById("cu").value = "";
    document.getElementById("cp").value = "";
    document.getElementById("ck").value = "";
  } else {
    showMsg("custMsg", "Fel: " + (json?.error || raw || "ok√§nt"));
  }
};

document.getElementById("refresh").onclick = loadLicenses;

// initial load
loadLicenses();
</script>

</body>
</html>
